%%{init: {"theme":"base","themeVariables":{
  "fontFamily":"Inter, system-ui, sans-serif",
  "background":"#0B1220",
  "primaryColor":"#111827",
  "primaryTextColor":"#E5E7EB",
  "primaryBorderColor":"#334155",
  "lineColor":"#94A3B8",
  "secondaryColor":"#0F172A",
  "tertiaryColor":"#111827",
  "textColor":"#E5E7EB",
  "signalTextColor":"#E5E7EB",
  "noteTextColor":"#E5E7EB",
  "noteBkgColor":"#0F172A",
  "actorBkg":"#111827",
  "actorBorder":"#334155",
  "actorTextColor":"#E5E7EB",
  "activationBkgColor":"#0F172A",
  "activationBorderColor":"#475569"
},
"sequence":{"rightAngles":true}}}%%
sequenceDiagram
  participant U as User
  participant UI as Mini Diarium UI
  participant BE as Rust Backend
  participant DB as SQLite diary.db (auth_slots)
  participant KF as Key File key

  U->>UI: Choose unlock method

  alt Password
      UI->>BE: Submit password
      BE->>DB: Load wrapped master key (password slot)
      DB-->>BE: Encrypted master key
      BE->>BE: Derive wrapping key (Argon2)\nAES-GCM unwrap
  else Key file
      UI->>BE: Select key file
      BE->>KF: Read X25519 private key
      KF-->>BE: Private key
      BE->>DB: Load wrapped master key (key slot)
      DB-->>BE: Encrypted master key
      BE->>BE: ECDH then HKDF then AES-GCM unwrap
  end

  BE->>BE: Open database connection
  BE->>BE: backup_and_rotate()
  BE->>BE: Update menu lock state
  BE-->>UI: Session unlocked
