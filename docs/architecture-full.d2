direction: down

title: {
  label: Mini Diarium Architecture
  near: top-center
  style: {
    font-size: 32
    bold: true
  }
}

# Layer 1: Presentation (SolidJS Components)
presentation: {
  label: "PRESENTATION LAYER\n(SolidJS Components)"
  style: {
    fill: "#e3f2fd"
    stroke: "#1976d2"
    stroke-width: 3
  }

  auth: {
    label: "Auth\nPasswordCreation\nPasswordPrompt\n(Password + Key File)"
    style.fill: "#bbdefb"
  }

  calendar: {
    label: "Calendar\nMonthly view\nEntry indicators"
    style.fill: "#bbdefb"
  }

  editor: {
    label: "Editor\nDiaryEditor (TipTap)\nTitleEditor\nWordCount"
    style.fill: "#bbdefb"
  }

  search: {
    label: "Search\nSearchBar\nSearchResults"
    style.fill: "#bbdefb"
  }

  overlays: {
    label: "Overlays\nGoToDate\nPreferences (+ Auth Methods)\nStats\nImport"
    style.fill: "#bbdefb"
  }
}

# Layer 2: State Management (Reactive Signals)
state: {
  label: "STATE LAYER\n(Reactive Signals)"
  style: {
    fill: "#f3e5f5"
    stroke: "#7b1fa2"
    stroke-width: 3
  }

  auth_state: {
    label: "auth.ts\nauthState · authMethods\nerror\ninitialize/create/unlock/lock\nunlockWithKeypair"
    style.fill: "#e1bee7"
  }

  entries_state: {
    label: "entries.ts\ncurrentEntry\nentryDates\nisLoading/isSaving"
    style.fill: "#e1bee7"
  }

  search_state: {
    label: "search.ts\nsearchQuery\nsearchResults\nisSearching"
    style.fill: "#e1bee7"
  }

  ui_state: {
    label: "ui.ts\nselectedDate\noverlay states\nsidebar state"
    style.fill: "#e1bee7"
  }

  preferences_state: {
    label: "preferences.ts\nPreferences interface\nlocalStorage persistence"
    style.fill: "#e1bee7"
  }
}

# Layer 3: IPC (Tauri Bridge)
ipc: {
  label: "IPC LAYER\n(Tauri invoke/listen)"
  style: {
    fill: "#fff3e0"
    stroke: "#f57c00"
    stroke-width: 3
  }

  tauri_wrappers: {
    label: "lib/tauri.ts\n33 typed invoke() wrappers\nauth · entries · search\nnav · stats · import · export"
    style.fill: "#ffe0b2"
  }

  shortcuts: {
    label: "lib/shortcuts.ts\nKeyboard shortcuts\nMenu event listeners\nlisten() handlers"
    style.fill: "#ffe0b2"
  }
}

# Layer 4: Backend Commands
commands: {
  label: "BACKEND COMMANDS\n(Rust #[tauri::command])"
  style: {
    fill: "#e8f5e9"
    stroke: "#388e3c"
    stroke-width: 3
  }

  auth_cmd: {
    label: "auth.rs\ncreate/unlock/lock · reset\nchange_password · verify_password\nunlock_with_keypair\nlist/register/remove auth methods\ngenerate_keypair · write_key_file"
    style.fill: "#c8e6c9"
  }

  entries_cmd: {
    label: "entries.rs\nsave_entry\nget_entry\ndelete_entry_if_empty\nget_all_entry_dates"
    style.fill: "#c8e6c9"
  }

  search_cmd: {
    label: "search.rs\nsearch_entries\nFTS5 query"
    style.fill: "#c8e6c9"
  }

  nav_cmd: {
    label: "navigation.rs\nnavigate_previous/next_day\nnavigate_to_today\nnavigate_previous/next_month"
    style.fill: "#c8e6c9"
  }

  stats_cmd: {
    label: "stats.rs\nget_statistics\naggregated counts\nstreaks & word counts"
    style.fill: "#c8e6c9"
  }

  import_cmd: {
    label: "import.rs\nimport orchestration\nformat parsers\nFTS rebuild"
    style.fill: "#c8e6c9"
  }

  export_cmd: {
    label: "export.rs\nexport_json\nexport_markdown\nHTML conversion"
    style.fill: "#c8e6c9"
  }
}

# Layer 5: Business Logic
business: {
  label: "BUSINESS LOGIC\n(Core Modules)"
  style: {
    fill: "#fce4ec"
    stroke: "#c2185b"
    stroke-width: 3
  }

  crypto: {
    label: "crypto/\npassword.rs (Argon2id)\ncipher.rs (AES-256-GCM)\nencrypt/decrypt"
    style.fill: "#f8bbd0"
  }

  db: {
    label: "db/\nschema.rs (migrations)\nqueries.rs (CRUD + FTS)\nSQL operations"
    style.fill: "#f8bbd0"
  }

  import: {
    label: "import/\nminidiary/dayone/jrnl\nparsers → DiaryEntry\nmerge.rs (conflict resolution)"
    style.fill: "#f8bbd0"
  }

  export: {
    label: "export/\njson.rs\nmarkdown.rs\nHTML-to-MD conversion"
    style.fill: "#f8bbd0"
  }

  menu: {
    label: "menu.rs\nApp menu builder\nevent emitter (app.emit)"
    style.fill: "#f8bbd0"
  }

  backup: {
    label: "backup.rs\nAuto backup on unlock\n5-backup rotation"
    style.fill: "#f8bbd0"
  }

  auth_module: {
    label: "auth/\npassword.rs (Argon2id wrap)\nkeypair.rs (X25519 ECIES)\nWrapped master key model"
    style.fill: "#f8bbd0"
  }
}

# Layer 6: Data Store
datastore: {
  label: "DATA STORE"
  style: {
    fill: "#eceff1"
    stroke: "#455a64"
    stroke-width: 3
  }

  database: {
    label: "SQLite Database"
    shape: cylinder
    style: {
      fill: "#cfd8dc"
      font-size: 16
      bold: true
    }
  }

  tables: {
    label: "Tables:\n• entries (encrypted text)\n• entries_fts (plaintext FTS5)\n• auth_slots (wrapped master key per method)\n• metadata (version, legacy)"
    style.fill: "#b0bec5"
  }
}

# Key: Dual Write Pattern Annotation
annotation: {
  label: "⚠️ CRITICAL PATTERN: Dual Write\nAll entry writes update BOTH:\n  1. entries table (encrypted)\n  2. entries_fts table (plaintext FTS5)\nFailure to update both causes search desync"
  near: top-right
  style: {
    fill: "#fff9c4"
    stroke: "#f57f17"
    stroke-width: 2
    font-size: 14
  }
}

# Connections - Presentation to State
presentation.auth -> state.auth_state: "reactive signals"
presentation.calendar -> state.entries_state: "dates"
presentation.calendar -> state.ui_state: "selectedDate"
presentation.editor -> state.entries_state: "currentEntry"
presentation.editor -> state.ui_state: "selectedDate"
presentation.search -> state.search_state: "query/results"
presentation.overlays -> state.ui_state: "overlay states"
presentation.overlays -> state.preferences_state: "settings"

# Connections - State to IPC
state.auth_state -> ipc.tauri_wrappers: "invoke()" {style.stroke-dash: 3}
state.entries_state -> ipc.tauri_wrappers: "invoke()" {style.stroke-dash: 3}
state.search_state -> ipc.tauri_wrappers: "invoke()" {style.stroke-dash: 3}

# Menu events (dashed = event-driven)
ipc.shortcuts -> state.entries_state: "listen(menu-*)" {style.stroke-dash: 5; style.stroke: "#f57c00"}
ipc.shortcuts -> state.ui_state: "listen(menu-*)" {style.stroke-dash: 5; style.stroke: "#f57c00"}

# Connections - IPC to Commands
ipc.tauri_wrappers -> commands.auth_cmd: "Tauri IPC"
ipc.tauri_wrappers -> commands.entries_cmd: "Tauri IPC"
ipc.tauri_wrappers -> commands.search_cmd: "Tauri IPC"
ipc.tauri_wrappers -> commands.nav_cmd: "Tauri IPC"
ipc.tauri_wrappers -> commands.stats_cmd: "Tauri IPC"
ipc.tauri_wrappers -> commands.import_cmd: "Tauri IPC"
ipc.tauri_wrappers -> commands.export_cmd: "Tauri IPC"

# Connections - Commands to Business Logic
commands.auth_cmd -> business.crypto: "password hash/verify"
commands.auth_cmd -> business.db: "create/open DB"
commands.auth_cmd -> business.backup: "backup on unlock"
commands.auth_cmd -> business.auth_module: "keypair wrap/unwrap"

commands.entries_cmd -> business.crypto: "encrypt/decrypt"
commands.entries_cmd -> business.db: "queries (dual write)"

commands.search_cmd -> business.db: "FTS5 search"

commands.nav_cmd -> business.db: "date queries"

commands.stats_cmd -> business.db: "aggregate queries"

commands.import_cmd -> business.import: "parse formats"
commands.import_cmd -> business.db: "merge + FTS rebuild"

commands.export_cmd -> business.export: "format conversion"
commands.export_cmd -> business.db: "fetch all entries"

# Menu events flow
business.menu -> ipc.shortcuts: "app.emit(menu-*)" {style.stroke-dash: 5; style.stroke: "#f57c00"}

# Connections - Business Logic to Data Store
business.crypto -> datastore.database: "key derivation"
business.db -> datastore.database: "SQL operations"
business.import -> datastore.database: "bulk insert"
business.export -> datastore.database: "read all"
business.backup -> datastore.database: "file copy"

datastore.database -> datastore.tables: "contains"
